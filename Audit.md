## Idle Governance

Idle governance is mostly based on the Compound governance model, more info can be found here:
- High level overview in the Introduction https://compound.finance/docs/governance
- Live contracts for Compound governance can be found here https://compound.finance/docs#networks
- Code https://github.com/compound-finance/compound-protocol

### Overview:

- Idle.sol -> is the ERC20 governance token of Idle protocol. Holders of this token have the ability to govern the protocol via the governor contract. Has the ability to delegate votes. Supports the permit pattern. No owner. Non upgradable.
- GovernorAlpha.sol -> The governance module, administrator of the Idle timelock contract. Holders of Idle token may create and vote on proposals which will be queued into the Idle timelock and then have effects on Idle idleToken and IdleController contracts (and more in the future).
- Timelock.sol -> Each idleToken contract and the IdleController contract will allow the Timelock to modify them. The Timelock contract can modify system parameters, logic, and contracts in a 'time-delayed, opt-out' upgrade pattern. The Timelock has a hard-coded minimum delay of 2 days, which is the least amount of notice possible for a governance action. Each proposed action will be published at a minimum of 2 days in the future from the time of announcement. Major upgrades, such as changing the risk system, may have a 14 day delay. The Timelock is controlled by the governance module;
- IdleController.sol -> used to decide how much IDLE to distribute at each idleToken pool based on the utility generated by each pool.
- Reservoir.sol -> IdleController ideally should hold all the LP rewards, something like 40% of the entire supply so it's very sensitive, and in order to enhance security we followed the Compound route of adding another contract, the `Reservoir.sol` that's basically a vesting contract where the beneficiary is IdleController.sol. This contract should be poked once in a while to drip all vested shares for the IdleController.

We forked most of the code from Compound (or some of it's audited variations like YAM for the `Idle.sol` implementation only). One thing to notice is that we updated the solidity version
from 0.5.16 to 0.6.12 so all pragma statements are different from the Compound's one.

I will detail all the changes in this format

`IdleFile.sol -> OriginalFile.sol | Protocol (eg Compound) | brief description of changes | diff_link_if_need.ed`

- [lib/CarefulMath.sol](contracts/lib/CarefulMath.sol) -> [CarefulMath.sol](https://github.com/compound-finance/compound-protocol/blob/master/contracts/CarefulMath.sol) | Compound | no changes
- [lib/Exponential.sol](contracts/lib/Exponential.sol) -> [Exponential.sol](https://github.com/compound-finance/compound-protocol/blob/master/contracts/Exponential.sol) | Compound | no changes
- [Idle.sol](contracts/Idle.sol) -> [YAMGovernance.sol](https://github.com/compound-finance/compound-protocol/blob/master/contracts/Idle.sol) + [YAMGovernanceStorage.sol](https://github.com/yam-finance/yam-protocol/blob/master/contracts/token/YAMGovernanceStorage.sol) | YAM (forked from Compound) | only difference is the constructor + added inheritance for ERC20Permit.sol described below | [diff](https://www.diffchecker.com/6PtfW32e)
- [ERC20Permit.sol](contracts/ERC20Permit.sol) -> [BalancerGovernanceToken.sol](https://etherscan.io/address/0xba100000625a3754423978a60c9317c58a424e3d#code) | Balancer | no changes extrapolated the permit pattern
- [GovernorAlpha.sol](contracts/GovernorAlpha.sol) -> [GovernorAlpha.sol](https://github.com/compound-finance/compound-protocol/blob/master/contracts/Governance/GovernorAlpha.sol) | Compound | basically unchanged, we only changed refs from Comp to Idle | [diff](https://www.diffchecker.com/U78SNWqd)
- [Timelock.sol](contracts/Timelock.sol) -> [Timelock.sol](https://github.com/compound-finance/compound-protocol/blob/master/contracts/Timelock.sol) | Compound | basically unchanged | [diff](https://www.diffchecker.com/zILhVzsy)
- [Reservoir.sol](contracts/Reservoir.sol) -> [Reservoir.sol](https://github.com/compound-finance/compound-protocol/blob/master/contracts/Reservoir.sol) | Compound | basically unchanged | [diff](https://www.diffchecker.com/MTSDvswp)
- [IdleController.sol](contracts/IdleController.sol) -> [ComptrollerG4.sol](https://github.com/compound-finance/compound-protocol/blob/master/contracts/ComptrollerG4.sol#L1096) + [ComptrollerStorage.sol](https://github.com/compound-finance/compound-protocol/blob/master/contracts/ComptrollerStorage.sol#L97) | Compound | we only took a small part of the Compound Comptroller and it's storage because we only needed the governance distribution from that file. We copied from line linked above (1096) to the end for the ComptrollerG4 and from line 97 of the ComptrollerStorage. We changed all ref from 'Comp' to 'Idle' and removed all stuff related to the borrowing side (which we do not use). We updated all `uint` to `uint256` and used. The main change that we made is regarding the logic behind `refreshIdleSpeedsInternal`, in this method we are calculating the utility generated by each Idle pool (idleDAI, idleUSDC ...), ie how much APR each pool is generating, and based on that we update the speeds at which each pool is getting IDLE tokens. The concept is the same used in Compound, the calculations and variable used are different. So in this file we basically changed only the method above the rest is the same as Compound.
- [PriceOracle.sol](contracts/PriceOracle.sol) NEW file. Chainlink oracle used in the `refreshIdleSpeedsInternal` above and in the `IdleTokenV3_1.sol` of the idle-contracts repo in order to calculate the avg APR of an Idle pool counting also governance tokens of other lending protocols (eg COMP)

[UPDATE 10.06.2020]
- added `Unitroller.sol` to handle upgradability and ownership of IdleController as Compound,
  forked the proxy contract, Unitroller, from (Compound)[https://github.com/compound-finance/compound-protocol/blob/master/contracts/Unitroller.sol], 1 line change in constructor where we set the implementation contract directly
- added missing `_supportMarkets` and `_addMarketInternal` to Idlecontroller.sol copied from
[ComptrollerG4](https://github.com/compound-finance/compound-protocol/blob/master/contracts/ComptrollerG4.sol#L997) .
`_supportMarkets` is the same as `_supportMarket` but wrapped in a for loop to allow supporting multiple markets in a single tx.
- added `EarlyRewards.sol` contract to distribute early lp rewards. This contract
has a mapping with user -> amount of IDLE that can be redeemd.
- added `Vester.sol` (don't need to be audited) forked from (Uniswap)[https://github.com/Uniswap/governance/blob/master/contracts/TreasuryVester.sol]. We added a single method `setDelegate` to allow investors and founders to delegate their IDLE votes to another address during the vesting period.
- added `VesterFactory.sol` (don't need to be audited) to deploy multiple Vester contract
